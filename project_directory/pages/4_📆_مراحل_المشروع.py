import streamlit as st
import pandas as pd
import os
from datetime import datetime

st.set_page_config(layout="centered")
st.title("ğŸ“… Ù…Ø±Ø§Ø­Ù„ Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ø´Ø±ÙˆØ¹")

DATA_PATH = "data/project_stages.csv"
os.makedirs("data", exist_ok=True)

# Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø«Ø§Ø¨ØªØ© (Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
STAGES_INFO = [
    {"Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø©": "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰", "Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø©": "Ø§Ù„ØªØ­Ø¶ÙŠØ± ÙˆØ§Ù„ØªØ®Ø·ÙŠØ·", "Ø§Ù„ÙˆØµÙ": "ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø±Ø¶ØŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªØ±Ø§Ø®ÙŠØµØŒ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠ ÙˆØ§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠ", "Ø§Ù„Ù…Ù‡Ø§Ù…": "- Ø±ÙØ¹ Ø§Ù„Ù…Ø³Ø§Ø­Ø©- Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ø®ØµØ© Ø§Ù„Ø¨Ù†Ø§Ø¡- ØªØµÙ…ÙŠÙ… Ù…Ø®Ø·Ø·Ø§Øª"},
    {"Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø©": "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©", "Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø©": "Ø§Ù„Ø­ÙØ± ÙˆØ§Ù„Ø£Ø³Ø§Ø³Ø§Øª", "Ø§Ù„ÙˆØµÙ": "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø­ÙØ± ÙˆØµØ¨ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ ÙˆØ§Ù„Ø£Ø³Ø§Ø³Ø§Øª", "Ø§Ù„Ù…Ù‡Ø§Ù…": "- Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø­ÙØ±- ØµØ¨ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯- Ø§Ù„Ø¹Ø²Ù„ Ø§Ù„Ø£Ø±Ø¶ÙŠ"},
    {"Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø©": "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©", "Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø©": "Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¦ÙŠ (Ø§Ù„Ø®Ø±Ø³Ø§Ù†Ø©)", "Ø§Ù„ÙˆØµÙ": "ØµØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙˆØ§Ù„Ø£Ø³Ù‚Ù ÙˆØ§Ù„Ø¬Ø¯Ø±Ø§Ù† Ø§Ù„Ø­Ø§Ù…Ù„Ø©", "Ø§Ù„Ù…Ù‡Ø§Ù…": "- ØµØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©- ØµØ¨ Ø§Ù„Ø³Ù‚Ù Ø§Ù„Ø£ÙˆÙ„- Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø±Ø§Ù†"},
    {"Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø©": "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©", "Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø©": "Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ø§Ù„Ø·ÙˆØ¨ ÙˆØ§Ù„Ø¨Ù„ÙˆÙƒ", "Ø§Ù„ÙˆØµÙ": "Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø¨Ø§Ù„Ø¬Ø¯Ø±Ø§Ù† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© ÙˆØ§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©", "Ø§Ù„Ù…Ù‡Ø§Ù…": "- Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø­ÙˆØ§Ø¦Ø·- ØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙØªØ­Ø§Øª Ù„Ù„Ù†ÙˆØ§ÙØ° ÙˆØ§Ù„Ø£Ø¨ÙˆØ§Ø¨"},
    {"Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø©": "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø®Ø§Ù…Ø³Ø©", "Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø©": "Ø§Ù„ØªÙ…Ø¯ÙŠØ¯Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©", "Ø§Ù„ÙˆØµÙ": "ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆØ³Ø¨Ø§ÙƒØ© ÙˆØªÙƒÙŠÙŠÙ Ù‚Ø¨Ù„ Ø§Ù„ØªØ´Ø·ÙŠØ¨Ø§Øª", "Ø§Ù„Ù…Ù‡Ø§Ù…": "- ØªÙ…Ø¯ÙŠØ¯ ÙƒÙ‡Ø±Ø¨Ø§Ø¡- ØªÙ…Ø¯ÙŠØ¯ ØµØ±Ù ØµØ­ÙŠ ÙˆÙ…ÙŠØ§Ù‡- ØªÙƒÙŠÙŠÙ"},
    {"Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø©": "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø³Ø§Ø¯Ø³Ø©", "Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø©": "Ø§Ù„ØªØ´Ø·ÙŠØ¨Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©", "Ø§Ù„ÙˆØµÙ": "ÙˆØ§Ø¬Ù‡Ø§ØªØŒ Ø¹Ø²Ù„ØŒ Ø¯Ù‡Ø§Ù† Ø®Ø§Ø±Ø¬ÙŠØŒ Ø¨ÙˆØ§Ø¨Ø§Øª", "Ø§Ù„Ù…Ù‡Ø§Ù…": "- Ø¯Ù‡Ø§Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª- ØªØ±ÙƒÙŠØ¨ Ø§Ù„Ø¥Ù†Ø§Ø±Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©"},
    {"Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø©": "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ø¹Ø©", "Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø©": "Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØ§Ù„ØªØ³Ù„ÙŠÙ…", "Ø§Ù„ÙˆØµÙ": "ÙØ­Øµ Ø§Ù„Ø£Ù†Ø¸Ù…Ø©ØŒ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ©ØŒ Ø¥Ø¹Ø¯Ø§Ø¯ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ³Ù„ÙŠÙ…", "Ø§Ù„Ù…Ù‡Ø§Ù…": "- ÙØ­Øµ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡- ÙØ­Øµ Ø§Ù„Ù…ÙŠØ§Ù‡- ØªÙ†Ø¸ÙŠÙ ÙˆØªØ³Ù„ÙŠÙ…"},
]

# Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹
def load_stages_data():
    if os.path.exists(DATA_PATH):
        df = pd.read_csv(DATA_PATH, parse_dates=["ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"])
        return df
    else:
        # Ø¨Ù†Ø§Ø¡ Ø¥Ø·Ø§Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        df = pd.DataFrame(STAGES_INFO)
        df["ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡"] = pd.NaT
        df["ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"] = pd.NaT
        df["Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© (Ø£ÙŠØ§Ù…)"] = 0
        return df

# Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
def save_stages_data(df):
    df.to_csv(DATA_PATH, index=False, encoding="utf-8")

# ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
df_stages = load_stages_data()

st.markdown("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ **ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡** Ùˆ**ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©** Ù„ÙƒÙ„ Ù…Ø±Ø­Ù„Ø©ØŒ ÙˆØ³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ **Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©** ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.")

# ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
for idx, row in df_stages.iterrows():
    st.markdown(f"### {row['Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø©']} - {row['Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø©']}")
    cols = st.columns(3)
    with cols[0]:
        start_date = st.date_input(
            "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡", 
            value=row["ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡"] if pd.notnull(row["ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡"]) else None, 
            key=f"start_{idx}"
        )
    with cols[1]:
        end_date = st.date_input(
            "ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©", 
            value=row["ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"] if pd.notnull(row["ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"]) else None, 
            key=f"end_{idx}"
        )
    # Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© (Ø¨Ø§Ù„ÙŠÙˆÙ…) ÙÙ‚Ø· Ø¥Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠÙ† Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ†
    duration = 0
    if start_date and end_date and end_date >= start_date:
        duration = (end_date - start_date).days + 1  # +1 Ù„ÙŠØ´Ù…Ù„ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø£ÙˆÙ„
    with cols[2]:
        st.text(f"Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© (Ø£ÙŠØ§Ù…): {duration}")

    # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø·Ø§Ø± Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    df_stages.at[idx, "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡"] = pd.to_datetime(start_date)
    df_stages.at[idx, "ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"] = pd.to_datetime(end_date)
    df_stages.at[idx, "Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© (Ø£ÙŠØ§Ù…)"] = duration

# Ø²Ø± Ø§Ù„Ø­ÙØ¸
if st.button("ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"):
    save_stages_data(df_stages)
    st.success("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!")

# Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
st.markdown("### ğŸ“Š Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹")
st.dataframe(df_stages.style.format({
    "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡": lambda d: d.strftime("%Y-%m-%d") if pd.notnull(d) else "",
    "ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©": lambda d: d.strftime("%Y-%m-%d") if pd.notnull(d) else "",
    "Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© (Ø£ÙŠØ§Ù…)": "{:.0f}"
}))
