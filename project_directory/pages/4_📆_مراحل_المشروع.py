import streamlit as st
import pandas as pd
import os

st.set_page_config(layout="centered")
st.title("๐๏ธ ูุฑุงุญู ุฅูุฌุงุฒ ุงููุดุฑูุน")

DATA_PATH = "data/project_phases.csv"
os.makedirs("data", exist_ok=True)

# ุฌุฏูู ุงููุฑุงุญู ูุน ุงูุฃุนูุฏุฉ ุงูุชู ุณูุฏุฎููุง ุงููุณุชุฎุฏู
default_phases = [
    {
        "ุฑูู ุงููุฑุญูุฉ": 1,
        "ุงุณู ุงููุฑุญูุฉ": "ุงูุชุญุถูุฑ ูุงูุชุฎุทูุท",
        "ุงููุตู": "ุชุญุฏูุฏ ุงูุฃุฑุถุ ุงุณุชุฎุฑุงุฌ ุงูุชุฑุงุฎูุตุ ุงูุชุตููู ุงูููุฏุณู ูุงููุนูุงุฑู",
        "ุงูููุงู ุงููุฑุชุจุทุฉ ุจุงููุฑุญูุฉ": "- ุฑูุน ุงููุณุงุญุฉ- ุงุณุชุฎุฑุงุฌ ุฑุฎุตุฉ ุงูุจูุงุก- ุชุตููู ูุฎุทุทุงุช",
        "ุชุงุฑูุฎ ุงูุจุฏุก": "",
        "ุชุงุฑูุฎ ุงูููุงูุฉ": "",
        "ุงููุฏุฉ ุงูุฒูููุฉ": ""
    },
    {
        "ุฑูู ุงููุฑุญูุฉ": 2,
        "ุงุณู ุงููุฑุญูุฉ": "ุงูุญูุฑ ูุงูุฃุณุงุณุงุช",
        "ุงููุตู": "ุฃุนูุงู ุงูุญูุฑ ูุตุจ ุงูููุงุนุฏ ูุงูุฃุณุงุณุงุช",
        "ุงูููุงู ุงููุฑุชุจุทุฉ ุจุงููุฑุญูุฉ": "- ุฃุนูุงู ุงูุญูุฑ- ุตุจ ุงูููุงุนุฏ- ุงูุนุฒู ุงูุฃุฑุถู",
        "ุชุงุฑูุฎ ุงูุจุฏุก": "",
        "ุชุงุฑูุฎ ุงูููุงูุฉ": "",
        "ุงููุฏุฉ ุงูุฒูููุฉ": ""
    },
    {
        "ุฑูู ุงููุฑุญูุฉ": 3,
        "ุงุณู ุงููุฑุญูุฉ": "ุงููููู ุงูุฅูุดุงุฆู (ุงูุฎุฑุณุงูุฉ)",
        "ุงููุตู": "ุตุจ ุงูุฃุนูุฏุฉ ูุงูุฃุณูู ูุงูุฌุฏุฑุงู ุงูุญุงููุฉ",
        "ุงูููุงู ุงููุฑุชุจุทุฉ ุจุงููุฑุญูุฉ": "- ุตุจ ุงูุฃุนูุฏุฉ- ุตุจ ุงูุณูู ุงูุฃูู- ุจูุงุก ุงูุฌุฏุฑุงู",
        "ุชุงุฑูุฎ ุงูุจุฏุก": "",
        "ุชุงุฑูุฎ ุงูููุงูุฉ": "",
        "ุงููุฏุฉ ุงูุฒูููุฉ": ""
    },
    {
        "ุฑูู ุงููุฑุญูุฉ": 4,
        "ุงุณู ุงููุฑุญูุฉ": "ุงูุจูุงุก ุจุงูุทูุจ ูุงูุจููู",
        "ุงููุตู": "ุฅุบูุงู ุงููููู ุจุงูุฌุฏุฑุงู ุงูุฏุงุฎููุฉ ูุงูุฎุงุฑุฌูุฉ",
        "ุงูููุงู ุงููุฑุชุจุทุฉ ุจุงููุฑุญูุฉ": "- ุจูุงุก ุงูุญูุงุฆุท- ุชุฌููุฒ ุงููุชุญุงุช ููููุงูุฐ ูุงูุฃุจูุงุจ",
        "ุชุงุฑูุฎ ุงูุจุฏุก": "",
        "ุชุงุฑูุฎ ุงูููุงูุฉ": "",
        "ุงููุฏุฉ ุงูุฒูููุฉ": ""
    },
    {
        "ุฑูู ุงููุฑุญูุฉ": 5,
        "ุงุณู ุงููุฑุญูุฉ": "ุงูุชูุฏูุฏุงุช ุงูุฃูููุฉ",
        "ุงููุตู": "ููุฑุจุงุก ูุณุจุงูุฉ ูุชูููู ูุจู ุงูุชุดุทูุจุงุช",
        "ุงูููุงู ุงููุฑุชุจุทุฉ ุจุงููุฑุญูุฉ": "- ุชูุฏูุฏ ููุฑุจุงุก- ุชูุฏูุฏ ุตุฑู ุตุญู ูููุงู- ุชูููู",
        "ุชุงุฑูุฎ ุงูุจุฏุก": "",
        "ุชุงุฑูุฎ ุงูููุงูุฉ": "",
        "ุงููุฏุฉ ุงูุฒูููุฉ": ""
    },
    {
        "ุฑูู ุงููุฑุญูุฉ": 6,
        "ุงุณู ุงููุฑุญูุฉ": "ุงูุชุดุทูุจุงุช ุงูุฎุงุฑุฌูุฉ",
        "ุงููุตู": "ูุงุฌูุงุชุ ุนุฒูุ ุฏูุงู ุฎุงุฑุฌูุ ุจูุงุจุงุช",
        "ุงูููุงู ุงููุฑุชุจุทุฉ ุจุงููุฑุญูุฉ": "- ุฏูุงู ุงููุงุฌูุงุช- ุชุฑููุจ ุงูุฅูุงุฑุฉ ุงูุฎุงุฑุฌูุฉ",
        "ุชุงุฑูุฎ ุงูุจุฏุก": "",
        "ุชุงุฑูุฎ ุงูููุงูุฉ": "",
        "ุงููุฏุฉ ุงูุฒูููุฉ": ""
    },
    {
        "ุฑูู ุงููุฑุญูุฉ": 7,
        "ุงุณู ุงููุฑุญูุฉ": "ุงูุงุฎุชุจุงุฑุงุช ูุงูุชุณููู",
        "ุงููุตู": "ูุญุต ุงูุฃูุธูุฉุ ุงูุชุฃูุฏ ูู ุงูุฌุงูุฒูุฉุ ุฅุนุฏุงุฏ ุชูุฑูุฑ ุงูุชุณููู",
        "ุงูููุงู ุงููุฑุชุจุทุฉ ุจุงููุฑุญูุฉ": "- ูุญุต ุงูููุฑุจุงุก- ูุญุต ุงูููุงู- ุชูุธูู ูุชุณููู",
        "ุชุงุฑูุฎ ุงูุจุฏุก": "",
        "ุชุงุฑูุฎ ุงูููุงูุฉ": "",
        "ุงููุฏุฉ ุงูุฒูููุฉ": ""
    }
]

def load_data():
    if os.path.exists(DATA_PATH):
        return pd.read_csv(DATA_PATH)
    else:
        return pd.DataFrame(default_phases)

def save_data(df):
    df.to_csv(DATA_PATH, index=False, encoding="utf-8")

df = load_data()

# ุนุฑุถ ุงูุฌุฏูู ูุน ุงูุฅุฏุฎุงู ูููุณุชุฎุฏู ููุท ูู ุชูุงุฑูุฎ ุงูุจุฏุงูุฉ ูุงูููุงูุฉ
st.markdown(
    """
    <style>
        .phase-box {
            background-color: #e0e0e0;
            color: #000000;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            font-size: 14px;
            direction: ltr;
            text-align: left;
        }
        .phase-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 6px;
        }
    </style>
    """,
    unsafe_allow_html=True
)

for idx, row in df.iterrows():
    st.markdown(f'<div class="phase-box">', unsafe_allow_html=True)
    st.markdown(f'<div class="phase-title">ุงููุฑุญูุฉ {row["ุฑูู ุงููุฑุญูุฉ"]}: {row["ุงุณู ุงููุฑุญูุฉ"]}</div>', unsafe_allow_html=True)
    st.markdown(f"<b>ุงููุตู:</b> {row['ุงููุตู']}<br><b>ุงูููุงู ุงููุฑุชุจุทุฉ:</b> {row['ุงูููุงู ุงููุฑุชุจุทุฉ ุจุงููุฑุญูุฉ']}", unsafe_allow_html=True)

    col1, col2, col3 = st.columns(3)
    with col1:
        df.at[idx, "ุชุงุฑูุฎ ุงูุจุฏุก"] = st.date_input(f"ุชุงุฑูุฎ ุงูุจุฏุก ูููุฑุญูุฉ {row['ุฑูู ุงููุฑุญูุฉ']}", 
                                                 value=pd.to_datetime(row["ุชุงุฑูุฎ ุงูุจุฏุก"]) if row["ุชุงุฑูุฎ ุงูุจุฏุก"] else None,
                                                 key=f"start_{idx}")
    with col2:
        df.at[idx, "ุชุงุฑูุฎ ุงูููุงูุฉ"] = st.date_input(f"ุชุงุฑูุฎ ุงูููุงูุฉ ูููุฑุญูุฉ {row['ุฑูู ุงููุฑุญูุฉ']}", 
                                                    value=pd.to_datetime(row["ุชุงุฑูุฎ ุงูููุงูุฉ"]) if row["ุชุงุฑูุฎ ุงูููุงูุฉ"] else None,
                                                    key=f"end_{idx}")
    with col3:
        # ุญุณุงุจ ุงููุฏุฉ ุชููุงุฆูุงู
        try:
            start = pd.to_datetime(df.at[idx, "ุชุงุฑูุฎ ุงูุจุฏุก"])
            end = pd.to_datetime(df.at[idx, "ุชุงุฑูุฎ ุงูููุงูุฉ"])
            if pd.notnull(start) and pd.notnull(end) and end >= start:
                duration = (end - start).days
                df.at[idx, "ุงููุฏุฉ ุงูุฒูููุฉ"] = duration
            else:
                df.at[idx, "ุงููุฏุฉ ุงูุฒูููุฉ"] = ""
        except Exception:
            df.at[idx, "ุงููุฏุฉ ุงูุฒูููุฉ"] = ""
        st.text_input(f"ุงููุฏุฉ ุงูุฒูููุฉ (ุจุงูุฃูุงู)", value=str(df.at[idx, "ุงููุฏุฉ ุงูุฒูููุฉ"]), disabled=True, key=f"duration_{idx}")

    st.markdown("</div>", unsafe_allow_html=True)

if st.button("๐พ ุญูุธ ุงููุฑุงุญู"):
    save_data(df)
    st.success("ุชู ุญูุธ ุงูุจูุงูุงุช ุจูุฌุงุญ.")
