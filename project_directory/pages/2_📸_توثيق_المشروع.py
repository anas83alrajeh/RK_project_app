import streamlit as st
import os
import pandas as pd
from PIL import Image
import uuid
from datetime import datetime
import logging
import streamlit.components.v1 as components

st.set_page_config(layout="centered")
st.title("ğŸ“¸ ØµÙØ­Ø© ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹")

DATA_DIR = "data/documentation"
META_FILE = os.path.join(DATA_DIR, "metadata.csv")
os.makedirs(DATA_DIR, exist_ok=True)

# Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø¬Ù„Ø³Ø©
if "should_rerun" not in st.session_state:
    st.session_state.should_rerun = False
if "desc_val" not in st.session_state:
    st.session_state.desc_val = ""
if "upload_key" not in st.session_state:
    st.session_state.upload_key = str(uuid.uuid4())

# Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯
if not os.path.exists(META_FILE):
    df = pd.DataFrame(columns=["Ø§Ù„ØµÙˆØ±Ø©", "Ø§Ù„ÙˆØµÙ", "Ø§Ù„ØªØ§Ø±ÙŠØ®"])
    df.to_csv(META_FILE, index=False, encoding="utf-8")

# Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
def load_df():
    try:
        return pd.read_csv(META_FILE)
    except Exception as e:
        logging.error(f"Error reading metadata file: {e}")
        return pd.DataFrame(columns=["Ø§Ù„ØµÙˆØ±Ø©", "Ø§Ù„ÙˆØµÙ", "Ø§Ù„ØªØ§Ø±ÙŠØ®"])

# Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸
def save_df(df):
    df.to_csv(META_FILE, index=False, encoding="utf-8")

# Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ©
def add_entry(date, description, image):
    img_id = str(uuid.uuid4()) + ".jpg"
    img_path = os.path.join(DATA_DIR, img_id)

    if image.mode in ("RGBA", "P"):
        image = image.convert("RGB")
    # Ù„Ø§ ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ø­Ø¬Ù… â€” Ø§Ù„ØµÙˆØ±Ø© ØªØ­ÙØ¸ ÙƒÙ…Ø§ Ù‡ÙŠ
    image.save(img_path)

    df = load_df()
    df.loc[len(df)] = [img_id, description, date]
    save_df(df)

    st.session_state.desc_val = ""
    st.session_state.upload_key = str(uuid.uuid4())
    st.session_state.should_rerun = True

# Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù
def delete_entry(idx):
    df = load_df()
    if df.empty:
        return
    img_file = df.loc[idx, "Ø§Ù„ØµÙˆØ±Ø©"]
    img_path = os.path.join(DATA_DIR, img_file)
    if os.path.exists(img_path):
        os.remove(img_path)
    df.drop(idx, inplace=True)
    df.reset_index(drop=True, inplace=True)
    save_df(df)
    st.session_state.should_rerun = True

# Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
st.subheader("â• Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©")
with st.form("image_form"):
    date = st.date_input("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©", value=datetime.today())
    desc = st.text_input("Ø§Ù„ÙˆØµÙ", value=st.session_state.desc_val)
    img_file = st.file_uploader("ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©", type=["jpg", "jpeg", "png"], key=st.session_state.upload_key)
    submitted = st.form_submit_button("Ø¥Ø¶Ø§ÙØ©")

    if submitted:
        if not img_file:
            st.error("ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ ØµÙˆØ±Ø©.")
        elif desc.strip() == "":
            st.error("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ÙˆØµÙ.")
        else:
            img_obj = Image.open(img_file)
            add_entry(date, desc, img_obj)

# Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ø§Ù„Ø­Ø°Ù
if st.session_state.should_rerun:
    st.session_state.should_rerun = False
    try:
        st.experimental_rerun()
    except Exception as e:
        logging.error(f"Error during rerun: {e}")
        components.html("<script>window.location.reload()</script>", height=0)

# Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±
st.subheader("ğŸ“‘ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø¶Ø§ÙØ©")
df = load_df()

if df.empty:
    st.info("Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.")
else:
    for idx, row in df.iterrows():
        cols = st.columns([1, 5, 1])
        img_path = os.path.join(DATA_DIR, row["Ø§Ù„ØµÙˆØ±Ø©"])

        with cols[0]:
            if os.path.exists(img_path):
                st.image(img_path)  # Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø­Ø¬Ù…Ù‡Ø§ Ø§Ù„Ø£ØµÙ„ÙŠ
            else:
                st.warning("âŒ Ø§Ù„ØµÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©")

        with cols[1]:
            st.markdown(
                f"""
                <div style="direction: rtl; text-align: right; background-color: #000; color: #fff; padding: 10px; border-radius: 8px;">
                    <strong>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> {row["Ø§Ù„ØªØ§Ø±ÙŠØ®"]}<br>
                    <strong>ğŸ“ Ø§Ù„ÙˆØµÙ:</strong> {row["Ø§Ù„ÙˆØµÙ"]}
                </div>
                """,
                unsafe_allow_html=True
            )

        with cols[2]:
            if st.button("ğŸ—‘ï¸ Ø­Ø°Ù", key=f"delete_{idx}"):
                delete_entry(idx)
